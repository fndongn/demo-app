pipeline {
    // Use any available Jenkins agent to run the pipeline
    agent any

    // Define environment variables
    environment {
        DOCKER_HUB_REPO = "kalelpower609/my-app"  // Your Docker Hub repository
        IMAGE_TAG = "latest"                        // Tag for the Docker image
    }

    stages {
        // Stage 1: Checkout the source code from GitHub
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/fndongn/ci-cd-push-docker-images-docker-hub.git' // Pull code from GitHub
            }
        }

        // Stage 2: Build the Docker image
        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker image..."
                    // Build Docker image using the Dockerfile in the current directory
                    docker.build("${DOCKER_HUB_REPO}:${IMAGE_TAG}", ".") 
                }
            }
        }

        // Stage 3: Login to Docker Hub using credentials stored in Jenkins
        stage('Login to Docker Hub') {
            steps {
                script {
                    // docker.withRegistry automatically logs in using credentials
                    docker.withRegistry('https://index.docker.io/v1/', 'DOCKERHUB_CREDENTIALS') {
                        echo "Logged in to Docker Hub."
                    }
                }
            }
        }

        // Stage 4: Push the Docker image to Docker Hub
        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'DOCKERHUB_CREDENTIALS') {
                        // Push the image to Docker Hub
                        docker.image("${DOCKER_HUB_REPO}:${IMAGE_TAG}").push()
                        echo "Docker image pushed successfully!"
                    }
                }
            }
        }
    }

    // Post-build actions
    post {
        // If the pipeline succeeds
        success {
            echo "Pipeline completed successfully!"
        }
        // If the pipeline fails
        failure {
            echo "Pipeline failed!"
        }
    }
}
